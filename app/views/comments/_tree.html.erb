<ul class="space-y-3" <%= "id=\"#{list_id}\"" if defined?(list_id) && list_id.present? %>>
  <% nodes.each do |comment, children| %>
    <li id="comment-tree-<%= comment.id %>" class="border rounded p-3">
      <div class="text-sm text-gray-500">
        <span><%= comment.user.try(:name) || "ユーザー##{comment.user_id}" %></span>
        ・<span><%= l(comment.created_at, format: :short) %></span>
        ・<span>t=<%= comment.video_timestamp_seconds %>s</span>
      </div>
      <div class="mt-1"><%= simple_format(h(comment.body)) %></div>

      <!-- 返信ボタンでフォームを表示 -->
      <div class="mt-2" data-controller="toggle">
        <button type="button"
                class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-800"
                data-action="click->toggle#toggle">
          返信
        </button>
        <div class="mt-2 hidden" data-toggle-target="panel">
          <%= render "comments/form",
                     video: video,
                     comment: video.comments.new(parent_id: comment.id, timeline_id: comment.timeline_id, video_timestamp_seconds: comment.video_timestamp_seconds) %>
        </div>
      </div>

      <div class="ml-4 mt-3 border-l pl-4">
        <%= render partial: "comments/tree", locals: { nodes: children.presence || {}, video: video, list_id: "replies-#{comment.id}" } %>
      </div>
    </li>
  <% end %>
</ul>
