<div class="max-w-3xl mx-auto px-4 py-6">
  <h1 class="text-2xl font-bold mb-4 text-center">цИжшбУуВпуВдуВ║</h1>

  <p class="text-lg mb-4 leading-relaxed"><%= @question.content %></p>

  <%= form_with url: answer_question_path(@question),
                method: :post,
                local: true,
                class: "space-y-4" do %>

    <ul class="space-y-3">
      <% @choices.each do |choice| %>
        <li class="border rounded-lg p-3 hover:bg-gray-50 cursor-pointer transition">
          <label class="flex items-center gap-3 text-base sm:text-lg">
            <%= radio_button_tag :choice_id, choice.id, false,
                  class: "h-5 w-5 sm:h-6 sm:w-6" %>
            <span><%= choice.body %></span>
          </label>
        </li>
      <% end %>
    </ul>

    <%= submit_tag "хЫЮчнФуБЩуВЛ",
        class: "w-full sm:w-auto px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition" %>
  <% end %>

  <% if defined?(@selected_choice) && @selected_choice.present? %>
    <hr class="my-6">

    <p class="text-lg font-medium mb-2">
      уБВуБкуБЯуБохЫЮчнФя╝Ъ<%= @selected_choice.body %>
    </p>

    <p class="text-xl font-bold mb-4 <%= @selected_choice.is_correct? ? 'text-green-600' : 'text-red-600' %>">
      <%= @selected_choice.is_correct? ? "цнгшзгя╝Б" : "ф╕НцнгшзгтАж" %>
    </p>

    <% if @ai.present? %>
      <div class="ai-explanation bg-gray-50 p-4 rounded-lg border space-y-4">

        <h3 class="text-xl font-semibold">ЁЯдЦ AIуБошзгшкм</h3>

        <p><strong>ЁЯУЛ шжБчВ╣:</strong> <%= @ai[:summary] %></p>
        <p><strong>ЁЯОп уБВуБкуБЯуБошзгчнФуБлуБдуБДуБж:</strong> <%= @ai[:selected_reason] %></p>

        <div>
          <h4 class="font-semibold mt-2 mb-2">ЁЯУЭ хРДщБ╕цКЮшВвуБошзгшкм</h4>
          <ul class="space-y-2">
            <% per = @ai[:per_choice] || [] %>
            <% per.each do |pc| %>
              <% choice_obj  = @choices[pc[:index].to_i - 1] %>
              <% choice_text = choice_obj&.body || "(щБ╕цКЮшВвуГЖуВнуВ╣уГИф╕НцШО)" %>

              <li class="p-2 bg-white rounded border">
                <strong><%= pc[:index] %>.</strong> <%= choice_text %>
                <span class="ml-1 <%= pc[:correct] ? 'text-green-600 font-bold' : 'text-red-600 font-bold' %>">
                  я╝И<%= pc[:correct] ? "тЬЕ цнгшзг" : "тЭМ ф╕Нцнгшзг" %>я╝Й
                </span>
                <div class="mt-1 text-sm text-gray-700">
                  <%= pc[:reason] %>
                </div>
              </li>
            <% end %>
          </ul>
        </div>

        <div class="tip-section mt-4">
          <p><strong>ЁЯТб хоЯцИжуГпуГ│уГЭуВдуГ│уГИ:</strong> <%= @ai[:tip] %></p>
        </div>

      </div>
    <% else %>
      <p class="font-semibold mt-4">шзгшкмя╝Ъ</p>
      <div class="bg-gray-50 p-4 rounded border mt-2 leading-relaxed">
        <%= simple_format(@question.explanation) %>
      </div>
    <% end %>

    <% if @next_question %>
      <div class="mt-6 text-center">
        <%= link_to "цмбуБохХПщбМуБ╕ тЦ╢",
            question_path(@next_question),
            class: "inline-block rounded-lg px-4 py-3 bg-blue-600 text-white hover:bg-blue-700 w-full sm:w-auto" %>
      </div>
    <% else %>
      <div class="mt-6 text-center">
        <%= link_to "ч╡Вф║Жя╝ИцЬАхИЭуБлцИ╗уВЛя╝Й",
            question_path(Question.order(:id).first),
            class: "inline-block rounded-lg px-4 py-3 bg-gray-600 text-white hover:bg-gray-700 w-full sm:w-auto" %>
      </div>
    <% end %>
  <% end %>
</div>